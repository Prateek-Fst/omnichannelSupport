{
  "info": {
    "name": "Simple Instagram Test",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:3000"
    },
    {
      "key": "orgId",
      "value": ""
    },
    {
      "key": "accessToken",
      "value": ""
    },
    {
      "key": "channelId",
      "value": ""
    },
    {
      "key": "customerId",
      "value": ""
    },
    {
      "key": "ticketId",
      "value": ""
    }
  ],
  "auth": {
    "type": "bearer",
    "bearer": [
      {
        "key": "token",
        "value": "{{accessToken}}",
        "type": "string"
      }
    ]
  },
  "item": [
    {
      "name": "1. Register Organization",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"orgName\": \"My Business {{$timestamp}}\",\n  \"name\": \"Owner\",\n  \"email\": \"owner{{$timestamp}}@test.com\",\n  \"password\": \"password123\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/auth/signup",
          "host": ["{{baseUrl}}"],
          "path": ["auth", "signup"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 201) {",
              "    const response = pm.response.json();",
              "    pm.collectionVariables.set('accessToken', response.accessToken);",
              "    pm.collectionVariables.set('orgId', response.user.orgId);",
              "    console.log('âœ… Organization registered');",
              "} else {",
              "    console.log('âŒ Registration failed - try login');",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "2. Login",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"email\": \"test@admin.com\",\n  \"password\": \"test12345\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/auth/login",
          "host": ["{{baseUrl}}"],
          "path": ["auth", "login"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const response = pm.response.json();",
              "    pm.collectionVariables.set('accessToken', response.accessToken);",
              "    pm.collectionVariables.set('orgId', response.user.orgId);",
              "    console.log('âœ… Login successful');",
              "} else {",
              "    console.log('âŒ Login failed');",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "3. Create Instagram Channel",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"type\": \"INSTAGRAM\",\n  \"name\": \"Instagram Channel\",\n  \"config\": {\n    \"pageId\": \"test_page\",\n    \"accessToken\": \"test_token\",\n    \"appSecret\": \"test_secret\"\n  }\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/orgs/{{orgId}}/channels",
          "host": ["{{baseUrl}}"],
          "path": ["orgs", "{{orgId}}", "channels"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 201) {",
              "    const response = pm.response.json();",
              "    pm.collectionVariables.set('channelId', response.id);",
              "    console.log('âœ… Channel created:', response.id);",
              "} else {",
              "    console.log('âŒ Channel creation failed');",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "4. Get Channels",
      "request": {
        "method": "GET",
        "url": {
          "raw": "{{baseUrl}}/orgs/{{orgId}}/channels",
          "host": ["{{baseUrl}}"],
          "path": ["orgs", "{{orgId}}", "channels"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const channels = pm.response.json();",
              "    console.log('âœ… Found', channels.length, 'channels');",
              "    if (channels.length > 0 && !pm.collectionVariables.get('channelId')) {",
              "        pm.collectionVariables.set('channelId', channels[0].id);",
              "    }",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "5. Instagram DM Webhook",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"entry\": [\n    {\n      \"messaging\": [\n        {\n          \"sender\": {\n            \"id\": \"customer_{{$timestamp}}\"\n          },\n          \"message\": {\n            \"mid\": \"msg_{{$timestamp}}\",\n            \"text\": \"Hi! I'm interested in your products\"\n          },\n          \"timestamp\": {{$timestamp}}000\n        }\n      ]\n    }\n  ]\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/webhook/{{channelId}}",
          "host": ["{{baseUrl}}"],
          "path": ["webhook", "{{channelId}}"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    console.log('âœ… DM webhook processed');",
              "} else {",
              "    console.log('âŒ Webhook failed');",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "6. Get Customers",
      "request": {
        "method": "GET",
        "url": {
          "raw": "{{baseUrl}}/orgs/{{orgId}}/customers",
          "host": ["{{baseUrl}}"],
          "path": ["orgs", "{{orgId}}", "customers"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const customers = pm.response.json();",
              "    console.log('âœ… Found', customers.length, 'customers');",
              "    customers.forEach(customer => {",
              "        console.log('ðŸ‘¤', customer.name, '(' + customer.platform + ')');",
              "    });",
              "    if (customers.length > 0) {",
              "        pm.collectionVariables.set('customerId', customers[0].id);",
              "    }",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "7. Get Customer Tickets",
      "request": {
        "method": "GET",
        "url": {
          "raw": "{{baseUrl}}/orgs/{{orgId}}/customers/{{customerId}}/tickets",
          "host": ["{{baseUrl}}"],
          "path": ["orgs", "{{orgId}}", "customers", "{{customerId}}", "tickets"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const tickets = pm.response.json();",
              "    console.log('âœ… Found', tickets.length, 'tickets');",
              "    if (tickets.length > 0) {",
              "        pm.collectionVariables.set('ticketId', tickets[0].id);",
              "    }",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "8. Get Messages",
      "request": {
        "method": "GET",
        "url": {
          "raw": "{{baseUrl}}/orgs/{{orgId}}/tickets/{{ticketId}}/messages",
          "host": ["{{baseUrl}}"],
          "path": ["orgs", "{{orgId}}", "tickets", "{{ticketId}}", "messages"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const messages = pm.response.json();",
              "    console.log('âœ… Found', messages.length, 'messages');",
              "    messages.forEach(msg => {",
              "        console.log(msg.direction + ':', msg.content);",
              "    });",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "9. Send Reply",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"content\": \"Hi! Thanks for your message. How can I help you?\",\n  \"metadata\": {\n    \"type\": \"agent_reply\"\n  }\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/orgs/{{orgId}}/tickets/{{ticketId}}/messages",
          "host": ["{{baseUrl}}"],
          "path": ["orgs", "{{orgId}}", "tickets", "{{ticketId}}", "messages"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 201) {",
              "    console.log('âœ… Reply sent successfully');",
              "} else {",
              "    console.log('âŒ Reply failed');",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "10. Get Notifications",
      "request": {
        "method": "GET",
        "url": {
          "raw": "{{baseUrl}}/orgs/{{orgId}}/notifications",
          "host": ["{{baseUrl}}"],
          "path": ["orgs", "{{orgId}}", "notifications"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const notifications = pm.response.json();",
              "    console.log('âœ… Found', notifications.length, 'notifications');",
              "    notifications.slice(0, 3).forEach(notif => {",
              "        console.log('ðŸ””', notif.type + ':', notif.title);",
              "    });",
              "}"
            ]
          }
        }
      ]
    }
  ]
}