{
  "info": {
    "name": "Instagram Onboarding Complete",
    "description": "Complete Instagram flow: Register â†’ Login â†’ Create Channel â†’ DM Webhook â†’ Customer Creation â†’ Chat",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:3000"
    },
    {
      "key": "orgId",
      "value": ""
    },
    {
      "key": "accessToken",
      "value": ""
    },
    {
      "key": "channelId",
      "value": ""
    },
    {
      "key": "customerId",
      "value": ""
    },
    {
      "key": "ticketId",
      "value": ""
    }
  ],
  "auth": {
    "type": "bearer",
    "bearer": [
      {
        "key": "token",
        "value": "{{accessToken}}",
        "type": "string"
      }
    ]
  },
  "item": [
    {
      "name": "ğŸ¢ 1. Organization Registration",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"orgName\": \"My Instagram Business {{$timestamp}}\",\n  \"name\": \"Business Owner\",\n  \"email\": \"owner{{$timestamp}}@business.com\",\n  \"password\": \"business123\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/auth/signup",
          "host": ["{{baseUrl}}"],
          "path": ["auth", "signup"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 201) {",
              "    const response = pm.response.json();",
              "    pm.collectionVariables.set('accessToken', response.accessToken);",
              "    pm.collectionVariables.set('orgId', response.user.orgId);",
              "    console.log('âœ… Organization registered successfully');",
              "    console.log('ğŸ¢ Organization:', response.organisation.name);",
              "    console.log('ğŸ‘¤ Admin:', response.user.name);",
              "    console.log('ğŸ“§ Email:', response.user.email);",
              "    console.log('ğŸ†” OrgId:', response.user.orgId);",
              "} else {",
              "    console.log('âŒ Registration failed:', pm.response.text());",
              "    console.log('ğŸ’¡ Try the login step instead if org already exists');",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "ğŸ” 2. Login (If Registration Failed)",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"email\": \"test@admin.com\",\n  \"password\": \"test12345\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/auth/login",
          "host": ["{{baseUrl}}"],
          "path": ["auth", "login"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const response = pm.response.json();",
              "    pm.collectionVariables.set('accessToken', response.accessToken);",
              "    pm.collectionVariables.set('orgId', response.user.orgId);",
              "    console.log('âœ… Login successful');",
              "    console.log('ğŸ‘¤ User:', response.user.name);",
              "    console.log('ğŸ†” OrgId:', response.user.orgId);",
              "} else {",
              "    console.log('âŒ Login failed:', pm.response.text());",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "ğŸ“± 3. Create Instagram Channel",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"type\": \"INSTAGRAM\",\n  \"name\": \"My Instagram Business Account\",\n  \"config\": {\n    \"pageId\": \"YOUR_INSTAGRAM_PAGE_ID\",\n    \"accessToken\": \"YOUR_INSTAGRAM_ACCESS_TOKEN\",\n    \"appSecret\": \"YOUR_APP_SECRET\",\n    \"webhookVerifyToken\": \"my_webhook_verify_token_123\"\n  }\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/orgs/{{orgId}}/channels",
          "host": ["{{baseUrl}}"],
          "path": ["orgs", "{{orgId}}", "channels"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 201) {",
              "    const response = pm.response.json();",
              "    pm.collectionVariables.set('channelId', response.id);",
              "    console.log('âœ… Instagram channel created successfully');",
              "    console.log('ğŸ“± Channel ID:', response.id);",
              "    console.log('ğŸ·ï¸  Channel Name:', response.name);",
              "    console.log('ğŸ”— Webhook URL: ' + pm.collectionVariables.get('baseUrl') + '/webhook/' + response.id);",
              "    console.log('');",
              "    console.log('ğŸ“‹ Next Steps:');",
              "    console.log('1. Add real Instagram credentials to the request body above');",
              "    console.log('2. Set up webhook in Facebook Developer Console');",
              "    console.log('3. Point webhook to: ' + pm.collectionVariables.get('baseUrl') + '/webhook/' + response.id);",
              "} else {",
              "    console.log('âŒ Channel creation failed:', pm.response.text());",
              "    console.log('ğŸ’¡ Channel might already exist - check next step');",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "ğŸ“‹ 4. Get All Channels",
      "request": {
        "method": "GET",
        "url": {
          "raw": "{{baseUrl}}/orgs/{{orgId}}/channels",
          "host": ["{{baseUrl}}"],
          "path": ["orgs", "{{orgId}}", "channels"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const channels = pm.response.json();",
              "    console.log('âœ… Found', channels.length, 'channels');",
              "    channels.forEach((channel, index) => {",
              "        console.log(`ğŸ“± ${index + 1}. ${channel.name} (${channel.type})`);",
              "        console.log(`   ğŸ†” ID: ${channel.id}`);",
              "        console.log(`   âœ… Active: ${channel.isActive}`);",
              "        console.log(`   ğŸ”— Webhook: ${pm.collectionVariables.get('baseUrl')}/webhook/${channel.id}`);",
              "    });",
              "    if (channels.length > 0 && !pm.collectionVariables.get('channelId')) {",
              "        pm.collectionVariables.set('channelId', channels[0].id);",
              "        console.log('ğŸ¯ Using existing channel:', channels[0].id);",
              "    }",
              "} else {",
              "    console.log('âŒ Failed to get channels');",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "ğŸ“± 5. Simulate Instagram DM (Someone messages you)",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"entry\": [\n    {\n      \"messaging\": [\n        {\n          \"sender\": {\n            \"id\": \"instagram_customer_{{$timestamp}}\"\n          },\n          \"message\": {\n            \"mid\": \"msg_{{$timestamp}}\",\n            \"text\": \"Hi! I saw your Instagram post about your products. I'm really interested in learning more. Can you help me choose the right product for my needs?\"\n          },\n          \"timestamp\": {{$timestamp}}000\n        }\n      ]\n    }\n  ]\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/webhook/{{channelId}}",
          "host": ["{{baseUrl}}"],
          "path": ["webhook", "{{channelId}}"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    console.log('âœ… Instagram DM webhook processed successfully');",
              "    console.log('ğŸ‘¤ Customer should be auto-created with Instagram details');",
              "    console.log('ğŸ’¬ Message: \"Hi! I saw your Instagram post...\"');",
              "    console.log('ğŸ« Ticket should be created for conversation');",
              "    console.log('ğŸ”” Notification should be generated');",
              "    console.log('');",
              "    console.log('â³ Processing... Check customers in next step');",
              "} else {",
              "    console.log('âŒ Instagram DM webhook failed:', pm.response.text());",
              "    console.log('ğŸ’¡ Make sure inbound worker is running: npm run worker:inbound');",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "ğŸ’¬ 6. Simulate Instagram Comment (Someone comments on your post)",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"entry\": [\n    {\n      \"changes\": [\n        {\n          \"field\": \"comments\",\n          \"value\": {\n            \"id\": \"comment_{{$timestamp}}\",\n            \"text\": \"Love this product! ğŸ˜ Where can I buy it? Do you ship internationally?\",\n            \"from\": {\n              \"username\": \"happy_customer_{{$timestamp}}\",\n              \"id\": \"user_{{$timestamp}}\"\n            },\n            \"created_time\": {{$timestamp}},\n            \"media\": {\n              \"id\": \"post_{{$timestamp}}\",\n              \"media_type\": \"IMAGE\"\n            }\n          }\n        }\n      ]\n    }\n  ]\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/webhook/{{channelId}}",
          "host": ["{{baseUrl}}"],
          "path": ["webhook", "{{channelId}}"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    console.log('âœ… Instagram comment webhook processed successfully');",
              "    console.log('ğŸ‘¤ Customer should be auto-created with comment details');",
              "    console.log('ğŸ’¬ Comment: \"Love this product! Where can I buy it?\"');",
              "    console.log('ğŸ« Ticket should be created for comment thread');",
              "    console.log('ğŸ”” Notification should be generated');",
              "} else {",
              "    console.log('âŒ Instagram comment webhook failed:', pm.response.text());",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "ğŸ‘¥ 7. Get All Customers (Auto-created from Instagram)",
      "request": {
        "method": "GET",
        "url": {
          "raw": "{{baseUrl}}/orgs/{{orgId}}/customers",
          "host": ["{{baseUrl}}"],
          "path": ["orgs", "{{orgId}}", "customers"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const customers = pm.response.json();",
              "    console.log('âœ… Found', customers.length, 'customers');",
              "    console.log('');",
              "    customers.forEach((customer, index) => {",
              "        console.log(`ğŸ‘¤ ${index + 1}. ${customer.name}`);",
              "        console.log(`   ğŸ“± Platform: ${customer.platform}`);",
              "        console.log(`   ğŸ†” External ID: ${customer.externalId}`);",
              "        console.log(`   ğŸ’¬ Last Message: ${customer.lastMessage}`);",
              "        console.log(`   ğŸ• Last Message At: ${customer.lastMessageAt}`);",
              "        console.log('');",
              "    });",
              "    if (customers.length > 0) {",
              "        pm.collectionVariables.set('customerId', customers[0].id);",
              "        console.log('ğŸ¯ Selected customer for chat:', customers[0].name);",
              "    } else {",
              "        console.log('âš ï¸  No customers found. Make sure:');",
              "        console.log('   1. Inbound worker is running');",
              "        console.log('   2. Webhook was processed successfully');",
              "        console.log('   3. Wait a few seconds and try again');",
              "    }",
              "} else {",
              "    console.log('âŒ Failed to get customers');",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "ğŸ“± 8. Get Instagram Customers Only",
      "request": {
        "method": "GET",
        "url": {
          "raw": "{{baseUrl}}/orgs/{{orgId}}/customers?platform=INSTAGRAM",
          "host": ["{{baseUrl}}"],
          "path": ["orgs", "{{orgId}}", "customers"],
          "query": [
            {
              "key": "platform",
              "value": "INSTAGRAM"
            }
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const customers = pm.response.json();",
              "    console.log('âœ… Found', customers.length, 'Instagram customers');",
              "    customers.forEach((customer, index) => {",
              "        console.log(`ğŸ“± ${index + 1}. ${customer.name} (${customer.platform})`);",
              "        console.log(`   ğŸ’¬ Last Message: ${customer.lastMessage}`);",
              "    });",
              "} else {",
              "    console.log('âŒ Failed to get Instagram customers');",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "ğŸ« 9. Get Customer Tickets (Conversations)",
      "request": {
        "method": "GET",
        "url": {
          "raw": "{{baseUrl}}/orgs/{{orgId}}/customers/{{customerId}}/tickets",
          "host": ["{{baseUrl}}"],
          "path": ["orgs", "{{orgId}}", "customers", "{{customerId}}", "tickets"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const tickets = pm.response.json();",
              "    console.log('âœ… Found', tickets.length, 'conversation tickets');",
              "    tickets.forEach((ticket, index) => {",
              "        console.log(`ğŸ« ${index + 1}. ${ticket.subject}`);",
              "        console.log(`   ğŸ“Š Status: ${ticket.status}`);",
              "        console.log(`   ğŸ”— Thread ID: ${ticket.externalThreadId}`);",
              "        console.log(`   ğŸ“… Created: ${ticket.createdAt}`);",
              "    });",
              "    if (tickets.length > 0) {",
              "        pm.collectionVariables.set('ticketId', tickets[0].id);",
              "        console.log('ğŸ¯ Selected ticket for chat:', tickets[0].id);",
              "    }",
              "} else {",
              "    console.log('âŒ Failed to get customer tickets');",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "ğŸ’¬ 10. Get Chat Messages (Conversation History)",
      "request": {
        "method": "GET",
        "url": {
          "raw": "{{baseUrl}}/orgs/{{orgId}}/tickets/{{ticketId}}/messages",
          "host": ["{{baseUrl}}"],
          "path": ["orgs", "{{orgId}}", "tickets", "{{ticketId}}", "messages"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const messages = pm.response.json();",
              "    console.log('âœ… Found', messages.length, 'messages in conversation');",
              "    console.log('');",
              "    console.log('ğŸ’¬ Conversation History:');",
              "    console.log('========================');",
              "    messages.forEach((msg, index) => {",
              "        const direction = msg.direction === 'INBOUND' ? 'ğŸ‘¤ Customer' : 'ğŸ¤– Agent';",
              "        const time = new Date(msg.createdAt).toLocaleTimeString();",
              "        console.log(`${direction} (${time}): ${msg.content}`);",
              "    });",
              "    console.log('========================');",
              "} else {",
              "    console.log('âŒ Failed to get chat messages');",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "ğŸ“¤ 11. Send Reply to Customer",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"content\": \"Hi! Thanks for your interest in our products! ğŸ˜Š I'd be happy to help you choose the perfect item. We have a wide range of products and I can provide personalized recommendations based on your specific needs. What type of product are you looking for?\",\n  \"metadata\": {\n    \"type\": \"customer_service_reply\",\n    \"agent\": \"business_owner\"\n  }\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/orgs/{{orgId}}/tickets/{{ticketId}}/messages",
          "host": ["{{baseUrl}}"],
          "path": ["orgs", "{{orgId}}", "tickets", "{{ticketId}}", "messages"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 201) {",
              "    const message = pm.response.json();",
              "    console.log('âœ… Reply sent successfully!');",
              "    console.log('ğŸ“¤ Message ID:', message.id);",
              "    console.log('ğŸ’¬ Content:', message.content);",
              "    console.log('ğŸ“± Direction:', message.direction);",
              "    console.log('');",
              "    console.log('ğŸš€ Message processing:');",
              "    console.log('   1. Message saved to database âœ…');",
              "    console.log('   2. Queued for outbound worker âœ…');",
              "    console.log('   3. Will be sent to Instagram via API');",
              "    console.log('');",
              "    console.log('ğŸ’¡ Check outbound worker logs for actual sending');",
              "    console.log('   Run: npm run worker:outbound');",
              "} else {",
              "    console.log('âŒ Failed to send reply:', pm.response.text());",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "ğŸ”” 12. Get Notifications (Real-time alerts)",
      "request": {
        "method": "GET",
        "url": {
          "raw": "{{baseUrl}}/orgs/{{orgId}}/notifications",
          "host": ["{{baseUrl}}"],
          "path": ["orgs", "{{orgId}}", "notifications"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const notifications = pm.response.json();",
              "    console.log('âœ… Found', notifications.length, 'notifications');",
              "    console.log('');",
              "    notifications.slice(0, 5).forEach((notif, index) => {",
              "        const readStatus = notif.isRead ? 'âœ… Read' : 'ğŸ”” Unread';",
              "        const time = new Date(notif.createdAt).toLocaleTimeString();",
              "        console.log(`${readStatus} ${notif.type} (${time})`);",
              "        console.log(`   ğŸ“‹ ${notif.title}`);",
              "        console.log(`   ğŸ’¬ ${notif.message}`);",
              "        console.log('');",
              "    });",
              "} else {",
              "    console.log('âŒ Failed to get notifications');",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "ğŸ“Š 13. Get Platform Statistics",
      "request": {
        "method": "GET",
        "url": {
          "raw": "{{baseUrl}}/orgs/{{orgId}}/customers/stats/platforms",
          "host": ["{{baseUrl}}"],
          "path": ["orgs", "{{orgId}}", "customers", "stats", "platforms"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const stats = pm.response.json();",
              "    console.log('âœ… Platform statistics:');",
              "    stats.forEach(stat => {",
              "        console.log(`ğŸ“± ${stat.platform}: ${stat.count} customers`);",
              "    });",
              "} else {",
              "    console.log('âŒ Failed to get platform stats');",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "ğŸ‰ 14. Complete Summary & Next Steps",
      "request": {
        "method": "GET",
        "url": {
          "raw": "{{baseUrl}}/orgs/{{orgId}}/customers/overview/dashboard",
          "host": ["{{baseUrl}}"],
          "path": ["orgs", "{{orgId}}", "customers", "overview", "dashboard"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const overview = pm.response.json();",
              "    console.log('ğŸ‰ INSTAGRAM ONBOARDING COMPLETE!');",
              "    console.log('================================');",
              "    console.log('');",
              "    console.log('ğŸ“Š Summary:');",
              "    console.log('ğŸ‘¥ Total customers:', overview.totalCustomers);",
              "    console.log('ğŸ“± Platform breakdown:');",
              "    overview.platformStats.forEach(stat => {",
              "        console.log(`   ${stat.platform}: ${stat.count} customers`);",
              "    });",
              "    console.log('');",
              "    console.log('âœ… What we accomplished:');",
              "    console.log('   ğŸ¢ Organization registered');",
              "    console.log('   ğŸ“± Instagram channel created');",
              "    console.log('   ğŸ”— Webhook endpoint configured');",
              "    console.log('   ğŸ‘¤ Customers auto-created from DMs/comments');",
              "    console.log('   ğŸ’¬ Chat interface working');",
              "    console.log('   ğŸ“¤ Reply system functional');",
              "    console.log('   ğŸ”” Notifications generated');",
              "    console.log('');",
              "    console.log('ğŸš€ Next Steps for Production:');",
              "    console.log('   1. Add real Instagram Business API credentials');",
              "    console.log('   2. Set up webhook in Facebook Developer Console');",
              "    console.log('   3. Point webhook to your server URL');",
              "    console.log('   4. Start inbound and outbound workers');",
              "    console.log('   5. Test with real Instagram DMs');",
              "    console.log('');",
              "    console.log('ğŸ¯ Your Instagram customer management system is ready!');",
              "} else {",
              "    console.log('âŒ Failed to get overview');",
              "}"
            ]
          }
        }
      ]
    }
  ]
}