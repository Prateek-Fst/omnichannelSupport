generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organisation {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users             User[]
  invites           Invite[]
  channels          Channel[]
  tickets           Ticket[]
  messages          Message[]
  macros            Macro[]
  campaigns         Campaign[]
  auditLogs         AuditLog[]
  ticketStatistics  TicketStatistics[]
  customers         Customer[]
  notifications     Notification[]

  @@index([id])
}

model User {
  id           String   @id @default(uuid())
  orgId        String
  organisation Organisation @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  name         String
  email        String   @unique
  passwordHash String
  role         Role     @default(AGENT)
  isActive     Boolean  @default(true)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  invitedUsers    Invite[]        @relation("invitedBy")
  assignedTickets Ticket[]        @relation("assignee")
  createdMacros   Macro[]         @relation("createdBy")
  createdCampaigns Campaign[]      @relation("createdBy")
  sentMessages    Message[]       @relation("sender")
  auditLogs       AuditLog[]      @relation("user")

  @@unique([orgId, email])
  @@index([orgId])
  @@index([email])
}

model Invite {
  id        String   @id @default(uuid())
  orgId     String
  organisation Organisation @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  email     String
  role      Role
  token     String   @unique
  invitedBy String
  invitedByUser User  @relation("invitedBy", fields: [invitedBy], references: [id], onDelete: Cascade)
  
  accepted  Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@unique([orgId, email])
  @@index([orgId])
  @@index([token])
}

model Channel {
  id        String   @id @default(uuid())
  orgId     String
  organisation Organisation @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  type      ChannelType
  name      String
  config    Json        @db.JsonB
  isActive  Boolean     @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tickets   Ticket[]
  messages  Message[]
  campaigns Campaign[]

  @@unique([orgId, type])
  @@index([orgId])
  @@index([type])
}

model Ticket {
  id                String   @id @default(uuid())
  orgId             String
  organisation      Organisation @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  channelId         String
  channel           Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  
  customerId        String?
  customer          Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  
  externalThreadId  String
  subject           String
  status            TicketStatus @default(OPEN)
  priority          Priority @default(MEDIUM)
  
  assigneeId        String?
  assignee          User?   @relation("assignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  messages          Message[]

  @@unique([channelId, externalThreadId])
  @@index([orgId])
  @@index([channelId])
  @@index([customerId])
  @@index([status])
  @@index([assigneeId])
}

model Message {
  id                String   @id @default(uuid())
  ticketId          String
  ticket            Ticket  @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  orgId             String
  organisation      Organisation @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  channelId         String
  channel           Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  
  direction         MessageDirection
  externalMessageId String?
  
  senderUserId      String?
  senderUser        User?   @relation("sender", fields: [senderUserId], references: [id], onDelete: SetNull)
  
  senderName        String
  content           String
  metadata          Json    @default("{}") @db.JsonB
  
  createdAt         DateTime @default(now())

  @@index([ticketId])
  @@index([orgId])
  @@index([channelId])
  @@index([direction])
}

model Macro {
  id        String   @id @default(uuid())
  orgId     String
  organisation Organisation @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  name      String
  content   String
  createdBy String
  createdByUser User @relation("createdBy", fields: [createdBy], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([orgId, name])
  @@index([orgId])
}

model Campaign {
  id               String   @id @default(uuid())
  orgId            String
  organisation     Organisation @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  channelId        String
  channel          Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  
  name             String
  messageTemplate  String
  status           CampaignStatus @default(DRAFT)
  scheduledAt      DateTime?
  
  createdBy        String
  createdByUser    User  @relation("createdBy", fields: [createdBy], references: [id], onDelete: Cascade)
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  recipients       CampaignRecipient[]

  @@index([orgId])
  @@index([status])
}

model CampaignRecipient {
  id               String   @id @default(uuid())
  campaignId       String
  campaign         Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  
  recipientContact String
  status           RecipientStatus @default(PENDING)
  sentAt           DateTime?
  error            String?
  
  createdAt        DateTime @default(now())

  @@index([campaignId])
  @@index([status])
}

model AuditLog {
  id        String   @id @default(uuid())
  orgId     String
  organisation Organisation @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  userId    String?
  user      User?   @relation("user", fields: [userId], references: [id], onDelete: SetNull)
  
  action    String
  entity    String
  entityId  String
  metadata  Json    @default("{}") @db.JsonB
  
  createdAt DateTime @default(now())

  @@index([orgId])
  @@index([userId])
  @@index([createdAt])
}

model TicketStatistics {
  id              String   @id @default(uuid())
  orgId           String
  organisation    Organisation @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  date            DateTime
  openCount       Int      @default(0)
  closedCount     Int      @default(0)
  avgResponseTime Int      @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([orgId, date])
  @@index([orgId])
  @@index([date])
}

enum Role {
  ADMIN
  AGENT
}

enum ChannelType {
  WHATSAPP
  INSTAGRAM
  FACEBOOK
  TWITTER
  LINKEDIN
  TELEGRAM
  EMAIL
  MOCK
}

enum TicketStatus {
  OPEN
  PENDING
  CLOSED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  COMPLETED
}

model Customer {
  id                String   @id @default(uuid())
  orgId             String
  organisation      Organisation @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  name              String
  avatar            String?
  platform          ChannelType
  externalId        String   // Platform-specific ID (Instagram ID, Facebook ID, etc.)
  
  lastMessageAt     DateTime?
  lastMessage       String?
  isActive          Boolean  @default(true)
  
  metadata          Json     @default("{}") @db.JsonB // Platform-specific data
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  tickets           Ticket[]

  @@unique([orgId, platform, externalId])
  @@index([orgId])
  @@index([platform])
  @@index([lastMessageAt])
}

model Notification {
  id        String   @id @default(uuid())
  orgId     String
  organisation Organisation @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  type      NotificationType
  title     String
  message   String
  data      Json     @default("{}") @db.JsonB
  
  isRead    Boolean  @default(false)
  readAt    DateTime?
  
  createdAt DateTime @default(now())

  @@index([orgId])
  @@index([isRead])
  @@index([createdAt])
}

enum RecipientStatus {
  PENDING
  SENT
  FAILED
}

enum NotificationType {
  NEW_MESSAGE
  NEW_COMMENT
  TICKET_ASSIGNED
  CUSTOMER_REPLY
}
